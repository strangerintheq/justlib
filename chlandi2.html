<!DOCTYPE html>
<html lang="en">
<body style="margin: 0;overflow:hidden;">
<script src="lib.js"></script>
<script src="palettes.js"></script>
<script src="gui.js"></script>
<script>
    const sabsValue = slider("sabsValue", 0.01,0.1)
    const shadow = slider("shadow", 2,11,8)
    const aa = slider("aa", 0,7)

    const ratio = innerWidth/innerHeight;
    palette(pick(Object.values(palettes)));

    const canvas = createCanvasWebgl(ratio,2);
    appendCanvas();
    let t;

    const redraw = webglProgram(`

    uniform vec2 r = [canvas.width, canvas.height];
    uniform float sabsValue = [0];
    uniform float shadow = [shadow.value];
    uniform float aa = [aa.value];
    uniform float t = [t];

    out vec4 fragColor;

    float sabs(float x) {
        return sqrt(pow(x,2.0)+sabsValue);
    }

    float rand(vec2 n) {
        return fract(sin(dot(n, vec2(12.9898, 4.1414))) * 43758.5453);
    }

    float noise(vec2 p){
        vec2 ip = floor(p);
        vec2 u = fract(p);
        u = u*u*(3.0-2.0*u);

        float res = mix(
        mix(rand(ip),rand(ip+vec2(1.0,0.0)),u.x),
        mix(rand(ip+vec2(0.0,1.0)),rand(ip+vec2(1.0,1.0)),u.x),u.y);
        return res*res;
    }

    float sfract(float x) {


        return  fract(-(x))/fwidth(x) ;
    }

    void main() {
        vec2 uv = gl_FragCoord.xy / r.xy - 0.5;
        uv.x *= r.x / r.y;
         uv *= 14.;
          float a = atan(uv.x+RND*7. - 3.5,uv.y+RND*7. - 3.5);
        ${pick([
            'uv.x = sabs(uv.x)-RND*2.;' +
            'uv.x = sabs(uv.x)-RND*2.;',
            // '',
            'uv = abs(uv)-RND*2.;uv = abs(uv)-RND*2.;'
        ])}
        vec2 p;
        float d, s, k;
        ${rndb()?'d += uv.x*RNDS*0.2;':''}
        ${rndb()?'d += uv.y*RNDS*0.2;':''}
        ${0?'d += noise(uv*0.4+4.)*11.*RND;':''}
        ${many(rndi(5,2), () => {
           return `
                p = RND2*7. - 3.5;
                s = RND*2.0 + 2.0;
                k = RND*2.;
                // uv *= mat2(cos(aa),-sin(aa),sin(aa),cos(aa));
                // uv -= aa;
                d += sin( log(length(uv-p)* k ) * s ) ;
           `
        }).join('\n')}

        float lightPower = shadow+(6.*RND*sin(d*RND*11.+${rndi(5,5)}.0*a));
        float shadowPower = shadow+(6.*RND*sin(d*RND*11.+${rndi(5,5)}.0*a));
        float light = pow(fract(d), lightPower) * .5;
        float shadow = -pow(1.0 - fract(d), shadowPower) ;
        vec3 color = palette(floor(d));
        fragColor = vec4( color + light + shadow , 1.0 );
        // if (d>2.25 && d < 2.5 )
            fragColor.rgb += smoothstep(3.25, 3.5, d)*(sin(uv.y*33.)+1.)*5.;
        if (d < 1. && d>0.) {
            ${pick([
                'fragColor.rgb -= cos(uv.x*155.*RND)*cos(uv.y*155.*RND)*.2+.2;',
                'fragColor.rgb -= cos(uv.x*155.)*.2+.2;',
                'fragColor.rgb -= cos(uv.y*77.)*.2+.2;',
            ])}
        }
    }
`);
    redraw();
    // loop(redraw)
    //
    // function loop(f){
    //     requestAnimationFrame(function loopFn(time){
    //         t = time/1000;
    //         f();
    //         requestAnimationFrame(loopFn)
    //     });
    // }
</script>
</body>
</html>